# AspectJ é¢å‘åˆ‡é¢ç¼–ç¨‹

### é—®é¢˜ä¸€ï¼šä»€ä¹ˆæ˜¯AspectJï¼Œä»€ä¹ˆæ˜¯é¢å‘åˆ‡é¢ç¼–ç¨‹



![dd](./images/xefZFzDq2uGN0pI80ZqsZ9HdGkv8aD2G.gif)

è¦äº†è§£ä»€ä¹ˆæ˜¯AspectJ , å¿…é¡»å…ˆè¦çŸ¥é“ä»€ä¹ˆæ˜¯AOPï¼ŒAOPåˆæ˜¯ä»€ä¹ˆğŸ‘»ï¼ŸAOPå°±æ˜¯é¢å‘åˆ‡é¢ç¼–ç¨‹çš„æ„æ€ï¼Œä½†æ˜¯çŸ¥é“AOPçš„å­—é¢æ„æ€æ˜¾ç„¶ä¸èƒ½æ¸…æ¥šçš„äº†è§£è¿™ä¸ªæ˜¯å¹²ä»€ä¹ˆçš„ï¼Œè¿™å°±éœ€è¦æˆ‘ä»¬å…ˆå›é¡¾ä¸‹æˆ‘ä»¬ä¹‹å‰åœ¨Javaç¼–ç¨‹ä¸­æ‰€ç†Ÿæ‚‰çš„ä¸€ä¸ªæ¦‚å¿µï¼ŒOOPï¼Œé¢å‘å¯¹è±¡ç¼–ç¨‹ï¼ŒOOPç¼–ç¨‹çš„å°±æ˜¯å«æˆ‘ä»¬å°†ä¸€ä¸ªäº‹ç‰©åˆ†ä¸ºå¥½å‡ ä¸ªæ­¥éª¤ï¼ŒæŒ‰ç…§æ¨¡å—æ¥è¿›è¡Œå¼€å‘ï¼Œç„¶åæŒ‰ç…§æŒ‡å®šçš„é¡ºåºæ¥æ‰§è¡Œè¿™äº›æ¨¡å—ï¼Œæ¯”å¦‚æˆ‘ä»¬ç†Ÿæ‚‰çš„æŠŠå¤§è±¡æ”¾è¿›å†°ç®±çš„ä¾‹å­ï¼Œå®ƒå°±æ˜¯æ¶‰åŠåˆ°ä¸¤ä¸ªå¯¹è±¡ï¼Œä¸‰ä¸ªæ­¥éª¤ã€‚

æ¶‰åŠåˆ°çš„å¯¹è±¡æœ‰ï¼š

- å¤§è±¡ Elephant 
- å†°ç®± Refrigerator

æ­¥éª¤åˆ†ä¸ºï¼š

1. æ‰“å¼€å†°ç®±
2. æŠŠå¤§è±¡æ”¾è¿›å†°ç®±
3. å…³é—­å†°ç®±

å¥½äº†ï¼ŒçŸ¥é“OOPæ˜¯ä»€ä¹ˆä¹‹åï¼Œæˆ‘ä»¬æ¥çœ‹ä»€ä¹ˆæ˜¯AOPï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰ã€‚é¢å‘åˆ‡é¢ç¼–ç¨‹æ˜¯ä¸€ç§æ€æƒ³ï¼Œå¯ä»¥å°†æŸä¸ªåŠŸèƒ½ä¸ä¸€æ‰¹å¯¹è±¡è¿›è¡Œéš”ç¦»ï¼Œä»è€Œè¾¾åˆ°ä¸è¿™æ‰¹å¯¹è±¡è¿›è¡Œè§£è€¦çš„ç›®çš„ã€‚è¿™é‡Œéš”ç¦»çš„æ„æ€å°±æ˜¯å¯æœ‰å¯æ— ï¼Œå¯æœ‰çš„æ„æ€å°±æ˜¯è¯´æ ‡è®°äº†è¿™ä¸ªæ¨¡å—æˆ‘å°±å¢åŠ ä¸€ä¸ªæ–°çš„åŠŸèƒ½äº†ï¼Œå¯æ— çš„æ„æ€å°±æ˜¯è¯´æˆ‘ä¸æ ‡è®°ï¼Œé‚£ä¹ˆæˆ‘å°±æ²¡æœ‰è¿™ä¸ªåŠŸèƒ½ã€‚æ³¨æ„ï¼Œè¿™é‡Œåˆæœ‰ä¸€ä¸ªæ–°çš„å…³é”®å­—ï¼Œ`æ ‡è®°` ï¼Œå¥½ï¼Œæˆ‘ä»¬æ¥ç†è§£æ ‡è®°çš„æ˜¯å•¥æ„æ€ï¼Œå…¶å®å‰é¢ä¸¤å¥å·²ç»è§£é‡Šçš„å¾ˆæ¸…æ¥šäº†ï¼Œå°±æ˜¯åœ¨é¡¹ç›®ä»£ç ä¸­æœ‰ä¸€ä¸ªæ ‡è®°ç”¨æ¥æ ‡æ³¨å‡ºæ¥è¿™ä¸ªæ–¹æ³•æ˜¯éœ€è¦æ–°å¢åŠ ä¸€ä¸ªåŠŸèƒ½è¿˜æ˜¯ä¸éœ€è¦ã€‚åˆ°æ­¤ï¼Œæˆ‘ä»¬å¤§æ¦‚æ¸…æ¥šAOPæ˜¯å¹²ä»€ä¹ˆçš„ï¼Œå°±æ˜¯åœ¨ä¸ä¿®æ”¹åŸæœ‰çš„ä»£ç åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±åŠ ä¸€ä¸ªæ–¹æ³•æ¥åšè‡ªå·±æƒ³è¦å¹²çš„äº‹æƒ…ï¼Œæ¯”å¦‚ï¼Œæˆ‘ä»¬åœ¨ç‚¹å‡»æ§ä»¶çš„æ—¶å€™ï¼ŒåŠ ä¸€ä¸ªç»Ÿè®¡ç‚¹å‡»æ¬¡æ•°çš„åŠŸèƒ½ï¼Œæˆ–è€…åœ¨ç‚¹å‡»çš„æ—¶å€™ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰ç½‘ç»œï¼Œå¦‚æœæœ‰ç½‘ç»œï¼Œå°±æŠŠæ•°æ®å­˜å‚¨åˆ°æœåŠ¡ä¸­ï¼Œå¦‚æœæ²¡æœ‰åˆ™å°±å­˜å‚¨åœ¨æœ¬åœ°ç£ç›˜ä¸­ï¼Œå†æ¯”å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æŸäº›æ–¹æ³•ä¸ŠåŠ ä¸€ä¸ªç»Ÿè®¡æ‰§è¡Œæ—¶é—´çš„åŠŸèƒ½ï¼Œæˆ–è€…æ‰§è¡Œæƒé™çš„åŠŸèƒ½ï¼Œåˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦æœ‰æ‰§è¡Œè¯¥æ–¹æ³•çš„æƒé™ã€‚

å—¯ï¼Œæˆ‘ä»¬æ¸…æ¥šäº†AOPçš„æ¦‚å¿µä¹‹åï¼Œåœ¨è§£é‡Šä¸‹AspectJ æ˜¯å¹²ä»€ä¹ˆçš„ï¼ŒAspectJ å°±æ˜¯å®ç°æˆ‘ä»¬AOPè¿™ç§æ€æƒ³çš„ä¸€ç§æ‰‹æ®µï¼Œå…¶å®ï¼Œè¿˜æœ‰å…¶ä»–å®ç°çš„æ‰‹æ®µï¼Œæ¯”å¦‚æ³¨è§£å¤„ç†å™¨ã€‚æœ‰äººå¯èƒ½ä¼šé—®ï¼Œå‘€ï¼Œä½ è¯´çš„æ€ä¹ˆå’ŒåŠ¨æ€ä»£ç†çš„å¥—è·¯å·®ä¸å¤šå•Šï¼Œæ˜¯çš„ï¼Œä¸€ä¸ªæ˜¯åœ¨ç¼–è¯‘çš„æ—¶å€™ï¼Œå°±æŠŠæˆ‘ä»¬æƒ³è¦çš„åŠŸèƒ½å·²ç»å†™åˆ°å­—èŠ‚ç ä¸­äº†ï¼Œå¦å¤–ä¸€ä¸ªå°±æ˜¯åœ¨ä»£ç è¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼ŒåŠ¨æ€æ‰§è¡Œæˆ‘ä»¬æ’å…¥çš„æ–¹æ³•ï¼Œå®ç°çš„æ–¹å¼ä¸ä¸€æ ·ã€‚



### é—®é¢˜äºŒï¼šAspectJ åœ¨é¡¹ç›®ä¸­å¦‚ä½•å¼•å…¥ï¼Ÿ

1. å¦‚ä½•åœ¨AndroidStudioé¡¹ç›®ä¸­å¼•å…¥ApsectJ ?

   åœ¨æˆ‘ä»¬é¡¹ç›®æ ¹ç›®å½•ä¸‹build.gradleæ–‡ä»¶ä¸­ï¼ŒåŠ å…¥å¦‚ä¸‹é…ç½®

   ```java
    repositories {
        google()
        mavenCentral()
        jcenter()
    }
   ```

   ```java
   dependencies {
        // é…ç½®AspectJ ç¬¬ä¸€æ­¥
        classpath 'org.aspectj:aspectjtools:1.8.13'
        classpath 'org.aspectj:aspectjweaver:1.8.13'   
   }
   ```

2. å¦‚ä½•åœ¨appç›®å½•ä¸‹è¿›è¡Œé…ç½®ï¼Ÿ

   åœ¨appç›®å½•ä¸‹çš„build.gradleè¿›è¡Œå¦‚ä¸‹é…ç½®

   ```java
   dependencies {
       //AOPé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼ŒåŠ å…¥è¿™è¡Œå°±ä¸ç”¨åœ¨libsä¸‹å¼•å…¥jaråŒ…äº†ï¼Œä¸ç„¶è¦å†™æˆcompile file(libs/aspectjrt.jar)
       implementation 'org.aspectj:aspectjrt:1.8.13'
   }
   ```

   ```java
   import org.aspectj.bridge.IMessage
   import org.aspectj.bridge.MessageHandler
   import org.aspectj.tools.ajc.Main
   
   final def log = project.logger
   final def variants = project.android.applicationVariants
   
   variants.all { variant ->
       if (!variant.buildType.isDebuggable()) {
           log.debug("Skipping non-debuggable build type '${variant.buildType.name}'.")
           return
       }
   
       JavaCompile javaCompile = variant.javaCompile
       javaCompile.doLast {
           String[] args = ["-showWeaveInfo",
                            "-1.5",
                            "-inpath", javaCompile.destinationDir.toString(),
                            "-aspectpath", javaCompile.classpath.asPath,
                            "-d", javaCompile.destinationDir.toString(),
                            "-classpath", javaCompile.classpath.asPath,
                            "-bootclasspath", project.android.bootClasspath.join(File.pathSeparator)]
           log.debug "ajc args: " + Arrays.toString(args)
   
           MessageHandler handler = new MessageHandler(true)
           new Main().run(args, handler)
           for (IMessage message : handler.getMessages(null, true)) {
               switch (message.getKind()) {
                   case IMessage.ABORT:
                   case IMessage.ERROR:
                   case IMessage.FAIL:
                       log.error message.message, message.thrown
                       break
                   case IMessage.WARNING:
                       log.warn message.message, message.thrown
                       break
                   case IMessage.INFO:
                       log.info message.message, message.thrown
                       break
                   case IMessage.DEBUG:
                       log.debug message.message, message.thrown
                       break
               }
           }
       }
   }
   ```

   å®Œæˆä»¥ä¸Šé…ç½®æ“ä½œä¹‹åï¼Œå°±å¯ä»¥è¿›è¡Œå†™ä»£ç å®ç°AOPæ€æƒ³çš„ç¯èŠ‚

### é—®é¢˜ä¸‰ï¼šAspectJ åœ¨é¡¹ç›®ä¸­å¦‚ä½•å®æˆ˜ï¼Ÿ

1. é¦–å…ˆæˆ‘ä»¬å…ˆå†™æˆ‘ä»¬çš„ä¸šåŠ¡ä»£ç  å³åœ¨æœªæ¥æˆ‘ä»¬å°†ä¾µå…¥çš„ä»£ç ï¼Œæœ€ç»ˆå®ç°ç»™è¿™äº›ä»£ç åŠ äº›æ–°åŠŸèƒ½

  ```java
   // æ‘‡ä¸€æ‘‡
    @OnClick(R.id.btn_shake)
    public void onShakeClick(){
        SystemClock.sleep(2000);
        Log.d(TAG, "onShakeClick: ç¾å¥³ï¼šä»Šæ™šæœ‰ç©ºå—ï¼Ÿå¥½çƒ­å•Š");
    }

    // å‘çº¢åŒ…
    @OnClick(R.id.btn_redpackage)
    public void onSendRedPackage(){
        SystemClock.sleep(1500);
        Log.d(TAG, "onSendRedPackage: ç¾å¥³ï¼šäº²çˆ±çš„ï¼Œæˆ‘çˆ±ä½ å“Ÿï¼Œä¹ˆä¹ˆå“’");
    }

    // å‘è¯­éŸ³
    @OnClick(R.id.btn_audio)
    public void onSendAudio(){
        SystemClock.sleep(1000);
        Log.d(TAG, "onSendAudio: ç¾å¥³ï¼šå»å“ªå„¿è§é¢ï¼ŒæœŸå¾…é©¬ä¸Šè§åˆ°ä½ ");
    }
  ```

2. ä¸šåŠ¡ä»£ç å®Œæˆä¹‹åï¼Œæˆ‘ä»¬å…ˆå†™ä¸€ä¸ªæ³¨è§£ï¼Œè¯¥æ³¨è§£å°±æ˜¯æˆ‘ä»¬å®ç°ä¾µå…¥çš„æ ‡è®°, ç„¶åç”¨æ³¨è§£æ ‡è®°ä¸šåŠ¡æ–¹æ³•

```java
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface BehaviorTrace {
    	String value();
    	int type();
}
```

```java
    // æ‘‡ä¸€æ‘‡
    @BehaviorTrace(value = "æ‘‡ä¸€æ‘‡", type = 0)
    @OnClick(R.id.btn_shake)
    public void onShakeClick(){
        SystemClock.sleep(2000);
        Log.d(TAG, "onShakeClick: ç¾å¥³ï¼šä»Šæ™šæœ‰ç©ºå—ï¼Ÿå¥½çƒ­å•Š");
    }


    // å‘çº¢åŒ…
    @BehaviorTrace(value = "å‘é€åŒ…", type = 1)
    @OnClick(R.id.btn_redpackage)
    public void onSendRedPackage(){
        SystemClock.sleep(1500);
        Log.d(TAG, "onSendRedPackage: ç¾å¥³ï¼šäº²çˆ±çš„ï¼Œæˆ‘çˆ±ä½ å“Ÿï¼Œä¹ˆä¹ˆå“’");
    }


    // å‘è¯­éŸ³
    @BehaviorTrace(value = "å‘è¯­éŸ³", type = 2)
    @OnClick(R.id.btn_audio)
    public void onSendAudio(){
        SystemClock.sleep(1000);
        Log.d(TAG, "onSendAudio: ç¾å¥³ï¼šå»å“ªå„¿è§é¢ï¼ŒæœŸå¾…é©¬ä¸Šè§åˆ°ä½ ");
    }

```



3. æ³¨è§£å†™å®Œä¹‹åï¼Œæˆ‘ä»¬éœ€è¦å®ç°æˆ‘ä»¬çš„ä¾µå…¥ä»£ç  

```java
@Aspect
public class BehaviorAspectJ {

    private static final String TAG = "BehaviorAspectJ";
    private SimpleDateFormat simpleDateFormat = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");

    // æ³¨è§£ æ³¨æ„ åé¢æ˜¯ * *ï¼ˆ..ï¼‰ æ ¼å¼åŠ¡å¿…æ˜¯è¿™æ ·çš„ å¦åˆ™å°±æœ‰é—®é¢˜äº†
    // åˆ‡å‡ºé‚£äº›è›‹ç³•
    @Pointcut("execution(@com.lucky.androidlearn.aspectj.BehaviorTrace * *(..))")
    public void annoBehavior(){}

    // æ€ä¹ˆåƒè›‹ç³•
    @Around("annoBehavior()")
    public Object dealPoint(ProceedingJoinPoint point) throws Throwable{
        // 1. è·å–åˆ°æ³¨è§£
        MethodSignature signature = (MethodSignature) point.getSignature();
        Method method = signature.getMethod();
        BehaviorTrace behaviorTrace = method.getAnnotation(BehaviorTrace.class);
        // 2. è·å–åˆ°æ³¨è§£çš„å€¼
        String value = behaviorTrace.value();
        Log.d(TAG, "dealPoint: value "+value+" date "+simpleDateFormat.format(new Date()));
        long beginTime = System.currentTimeMillis();
        // 3. è°ƒç”¨è¢«æ³¨è§£çš„æ–¹æ³•
        Object object = point.proceed();
        // 4. æ‰§è¡Œåˆ‡é¢ç¼–ç¨‹åŠ å…¥çš„æ–¹æ³•
        Log.d(TAG, "dealPoint: costTime "+(System.currentTimeMillis() - beginTime));
        return object;
    }

```

4. è§‚å¯Ÿç»“æœï¼Œæ˜¯å¦å®ç°æˆ‘ä»¬çš„ç›®æ ‡ åœ¨ä¸ä¿®æ”¹ä¸šåŠ¡ä»£ç çš„æƒ…å†µä¸‹ï¼Œæ–°å¢åŠ äº†ä¸€ä¸ªæ—¶é—´æˆ³å’Œæ–¹æ³•æ—¶é•¿çš„åŠŸèƒ½

```java
com.lucky.androidlearn D/BehaviorAspectJ: dealPoint: value æ‘‡ä¸€æ‘‡ date 2020-02-18 00:17:33
com.lucky.androidlearn D/AspectJActivity: onShakeClick: ç¾å¥³ï¼šä»Šæ™šæœ‰ç©ºå—ï¼Ÿå¥½çƒ­å•Š
com.lucky.androidlearn D/BehaviorAspectJ: dealPoint: costTime 2001
```

```java
com.lucky.androidlearn D/BehaviorAspectJ: dealPoint: value å‘é€åŒ… date 2020-02-18 00:18:42
com.lucky.androidlearn D/AspectJActivity: onSendRedPackage: ç¾å¥³ï¼šäº²çˆ±çš„ï¼Œæˆ‘çˆ±ä½ å“Ÿï¼Œä¹ˆä¹ˆå“’
com.lucky.androidlearn D/BehaviorAspectJ: dealPoint: costTime 1501
```

```java
com.lucky.androidlearn D/BehaviorAspectJ: dealPoint: value å‘è¯­éŸ³ date 2020-02-18 00:19:21
com.lucky.androidlearn D/AspectJActivity: onSendAudio: ç¾å¥³ï¼šå»å“ªå„¿è§é¢ï¼ŒæœŸå¾…é©¬ä¸Šè§åˆ°ä½ 
com.lucky.androidlearn D/BehaviorAspectJ: dealPoint: costTime 1002
```

<img src="./images/1488546236946.jpg" style="zoom:200%;" />







